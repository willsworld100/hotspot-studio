<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hotspot Studio ‚Äî Clean URL Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--navy:#06283d;--offwhite:#f9f8f4;--accent:#4f9d69;--muted:#476072;}
html,body{height:100%;margin:0;background:var(--offwhite);color:var(--navy);font-family:"Lexend",system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
.app{padding:14px;display:flex;flex-direction:column;gap:12px;}
.header{display:flex;flex-direction:column;gap:6px}
h1{margin:0;font-size:20px}
.credit{color:var(--muted);font-size:13px}
.top-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
button{font-family:inherit;cursor:pointer;border:none;border-radius:8px;padding:8px 12px;background:var(--navy);color:var(--offwhite);}
button.ghost{background:transparent;border:1px solid rgba(6,40,61,0.12);color:var(--navy);}
.smallmuted{color:var(--muted);font-size:13px}
.stage{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(6,40,61,0.06);display:flex;align-items:center;justify-content:center;min-height:360px;position:relative;}
.stage img{display:block;max-width:100%;border-radius:6px;user-select:none;}
.hotspot{position:absolute;transform:translate(-50%,-50%);cursor:pointer;}
.dot{border-radius:50%;border:3px solid rgba(255,255,255,0.95);box-shadow:0 6px 14px rgba(6,40,61,0.12);display:block;}
.label{position:absolute;top:-200%;left:50%;transform:translateX(-50%);background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 8px 22px rgba(6,40,61,0.12);display:none;color:var(--navy);min-width:150px;}
.hotspot:hover .label{display:block;}
.list{margin-top:8px;max-height:200px;overflow:auto;}
.item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(6,40,61,0.02);}
.mini{width:18px;height:18px;border-radius:50%;}
.footer{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;margin-top:12px;}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <h1>Hotspot Studio</h1>
    <div class="smallmuted credit">- Will Salter</div>
    <div class="top-controls">
      <label for="fileImage" style="cursor:pointer;background:#06283d;color:#fff;padding:8px 12px;border-radius:8px;">üìÅ Upload image</label>
      <input type="file" id="fileImage" accept="image/*" style="display:none;" />

      <button id="btnLoadImageUrl">üîó Load Image from URL</button>

      <label for="fileScene" style="cursor:pointer;background:#06283d;color:#fff;padding:8px 12px;border-radius:8px;">üìÇ Load Scene</label>
      <input type="file" id="fileScene" accept="application/json" style="display:none;" />

      <button id="btnSave" class="ghost">üíæ Save JSON</button>
      <button id="btnUndo" class="ghost">‚Ü©Ô∏è Undo</button>
      <button id="btnToggleMode">üéì Switch to Explore Mode</button>
      <button id="btnResetSummary" class="ghost">üîÑ Reset Explore</button>
    </div>
  </header>

  <div class="stage" id="stage">
    <div id="scene">
      <div id="emptyPrompt" style="padding:36px;text-align:center;color:var(--muted)">
        No image yet ‚Äî upload or load one to begin.
      </div>
    </div>
  </div>

  <div class="list" id="foundList"></div>
  <div class="footer" id="completion"></div>
</div>

<script>
(() => {
  const fileImage = document.getElementById('fileImage');
  const btnLoadImageUrl = document.getElementById('btnLoadImageUrl');
  const fileScene = document.getElementById('fileScene');
  const btnSave = document.getElementById('btnSave');
  const btnUndo = document.getElementById('btnUndo');
  const btnToggleMode = document.getElementById('btnToggleMode');
  const btnResetSummary = document.getElementById('btnResetSummary');

  const sceneEl = document.getElementById('scene');
  const emptyPrompt = document.getElementById('emptyPrompt');
  const foundListEl = document.getElementById('foundList');
  const completionEl = document.getElementById('completion');

  let scene = { imageDataUrl:null, imageURL:null, hotspots:[] };
  let isExploreMode = false;
  let foundSet = new Set();

  function uid(){return 'h'+Math.random().toString(36).slice(2,9);}
  function pct(v){return Math.round(v*100)/100;}
  function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  function readFileAsDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=()=>rej(r.error);r.readAsDataURL(file);});}
  function readFileAsText(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=()=>rej(r.error);r.readAsText(file);});}
  function downloadData(str,filename,mime){const blob=new Blob([str],{type:mime||'application/octet-stream'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}

  function convertDriveUrlToDirect(url){
    try{
      if(url.startsWith('data:')||url.match(/^https?:\/\/.+\.(png|jpg|jpeg|gif|webp|svg)(?:$|\?)/i))return url;
      const m1=url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);if(m1&&m1[1])return `https://drive.google.com/uc?export=view&id=${m1[1]}`;
      const m2=url.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(m2&&m2[1])return `https://drive.google.com/uc?export=view&id=${m2[1]}`;
      return url;
    }catch(e){return url;}
  }

  async function checkImageLoadable(url){const res=await fetch(url,{mode:'cors'});if(!res.ok)throw new Error('HTTP '+res.status);const blob=await res.blob();if(!blob.type.startsWith('image/'))throw new Error('Not an image');return true;}

  async function applyLoadedScene(obj){
    if(!obj || !Array.isArray(obj.hotspots)) throw new Error('Invalid JSON');
    scene.hotspots=obj.hotspots.map(h=>({id:h.id||uid(),x:h.x,y:h.y,color:h.color||'#ff6b6b',size:h.size||22,title:h.title||'Hotspot',text:h.text||''}));
    foundSet.clear();
    if(obj.imageURL){
      const direct=convertDriveUrlToDirect(obj.imageURL);
      await checkImageLoadable(direct);
      scene.imageURL=direct; scene.imageDataUrl=null;
      renderScene(); return;
    }
    if(obj.imageDataUrl){scene.imageDataUrl=obj.imageDataUrl;scene.imageURL=null;renderScene();return;}
    scene.imageDataUrl=null;scene.imageURL=null;renderScene();alert('No image in scene, please load one manually.');  
  }

  function renderScene(){
    sceneEl.innerHTML='';
    if(!scene.imageDataUrl&&!scene.imageURL){sceneEl.appendChild(emptyPrompt);return;}
    const img=document.createElement('img');img.draggable=false;
    img.src=scene.imageURL||scene.imageDataUrl;
    sceneEl.appendChild(img);
    img.onload=()=>{
      scene.hotspots.forEach(h=>{sceneEl.appendChild(makeHotspotElement(h));});
    };
    img.onerror=()=>{alert('Failed to load image. Make sure link is valid and accessible.');scene.imageDataUrl=null;scene.imageURL=null;scene.hotspots=[];sceneEl.innerHTML='';sceneEl.appendChild(emptyPrompt);}
  }

  function makeHotspotElement(h){
    const hs=document.createElement('button');hs.className='hotspot';hs.dataset.id=h.id;
    hs.style.left=h.x+'%';hs.style.top=h.y+'%';hs.style.width=(h.size+8)+'px';hs.style.height=(h.size+8)+'px';
    const dot=document.createElement('span');dot.className='dot';dot.style.background=h.color;dot.style.width=h.size+'px';dot.style.height=h.size+'px';
    hs.appendChild(dot);
    const label=document.createElement('div');label.className='label';label.innerHTML='<strong>'+escapeHtml(h.title||'')+'</strong><div style="margin-top:6px;font-size:13px">'+escapeHtml(h.text||'')+'</div>';
    hs.appendChild(label);
    hs.addEventListener('click',(evt)=>{
      evt.stopPropagation();
      if(isExploreMode&&!foundSet.has(h.id)){foundSet.add(h.id);updateSummary();}
    });
    return hs;
  }

  function updateSummary(){
    foundListEl.innerHTML='';Array.from(foundSet).forEach(id=>{const h=scene.hotspots.find(x=>x.id===id);if(!h)return;const d=document.createElement('div');d.innerHTML='<strong>'+escapeHtml(h.title)+'</strong>: '+escapeHtml(h.text);foundListEl.appendChild(d);});
    completionEl.textContent=scene.hotspots.length>0?`Found ${foundSet.size} of ${scene.hotspots.length} hotspots (${Math.round(foundSet.size/scene.hotspots.length*100)}%)`:'';
  }

  // Event listeners
  fileImage.addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const dataUrl=await readFileAsDataURL(f);scene.imageDataUrl=dataUrl;scene.imageURL=null;scene.hotspots=[];foundSet.clear();renderScene();fileImage.value='';});
  btnLoadImageUrl.addEventListener('click',async()=>{const url=prompt('Paste an image URL (or Google Drive share link):');if(!url)return;try{const direct=convertDriveUrlToDirect(url.trim());await checkImageLoadable(direct);scene.imageURL=direct;scene.imageDataUrl=null;scene.hotspots=[];foundSet.clear();renderScene();alert('Image loaded from URL.');}catch(err){alert('Could not load image: '+err.message);}});
  fileScene.addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const text=await readFileAsText(f);await applyLoadedScene(JSON.parse(text));fileScene.value='';});
  btnSave.addEventListener('click',()=>{const exportObj={hotspots:scene.hotspots.slice()};if(scene.imageURL)exportObj.imageURL=scene.imageURL;else if(scene.imageDataUrl)exportObj.imageDataUrl=scene.imageDataUrl;downloadData(JSON.stringify(exportObj,null,2),'hotspot-scene.json','application/json');});
  btnUndo.addEventListener('click',()=>{scene.hotspots.pop();renderScene();});
  btnToggleMode.addEventListener('click',()=>{isExploreMode=!isExploreMode;foundSet.clear();updateSummary();renderScene();});
  btnResetSummary.addEventListener('click',()=>{foundSet.clear();updateSummary();});

  sceneEl.addEventListener('click',e=>{if(isExploreMode)return;const img=sceneEl.querySelector('img');if(!img)return;if(e.target.closest('.hotspot'))return;const rect=img.getBoundingClientRect();const x=(e.clientX-rect.left)/rect.width*100;const y=(e.clientY-rect.top)/rect.height*100;scene.hotspots.push({id:uid(),x:x,y:y,color:'#ff6b6b',size:22,title:'New hotspot',text:'Edit this description'});renderScene();});

  renderScene();

})();
</script>
</body>
</html>
