<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hotspot Studio â€” URL Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--navy:#06283d;--offwhite:#f9f8f4;--accent:#4f9d69;--muted:#476072;}
html,body{height:100%;margin:0;background:var(--offwhite);color:var(--navy);font-family:"Lexend",system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
.app{padding:14px;box-sizing:border-box;display:flex;flex-direction:column;gap:12px;height:100%;}
.header{display:flex;flex-direction:column;gap:6px}
.title-row{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
.credit{color:var(--muted);font-size:13px}
.top-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
button,select,input,textarea{font-family:inherit}
.btn{background:var(--navy);color:var(--offwhite);border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(6,40,61,0.12);color:var(--navy)}
.small{font-size:13px;color:var(--muted)}
.main{display:flex;gap:12px;flex:1;min-height:0}
.panel{width:320px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(6,40,61,0.06);overflow:auto}
.stage-wrap{flex:1;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;min-width:0}
.stage{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(6,40,61,0.06);max-width:100%;max-height:100%;overflow:auto;display:flex;align-items:center;justify-content:center;min-height:360px}
.scene{position:relative;display:inline-block;user-select:none;outline:4px solid rgba(6,40,61,0.03);border-radius:6px;padding:6px}
.scene img{display:block;max-width:calc(100vw - 520px);max-height:calc(100vh - 240px);border-radius:6px}
.hotspot{position:absolute;transform:translate(-50%,-50%);cursor:pointer;z-index:2}
.dot{border-radius:50%;border:3px solid rgba(255,255,255,0.95);box-shadow:0 6px 14px rgba(6,40,61,0.12);display:block}
.label{position:absolute;top:-220%;left:50%;transform:translateX(-50%);background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 8px 22px rgba(6,40,61,0.12);display:none;color:var(--navy);min-width:150px}
.hotspot:hover .label{display:block}
.smallmuted{color:var(--muted);font-size:13px}
.list{margin-top:8px;max-height:260px;overflow:auto}
.item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(6,40,61,0.02)}
.mini{width:18px;height:18px;border-radius:50%}
.footer{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px}
.editor-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center}
.editor-box{background:#fff;border-radius:12px;padding:14px;width:360px;box-shadow:0 8px 40px rgba(6,40,61,0.16)}
.editor-box label{display:block;margin-top:8px;font-weight:600}
.editor-box input,.editor-box textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(6,40,61,0.08);margin-top:6px;font-family:inherit}
.editor-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.mode-ind{padding:6px 8px;border-radius:8px;background:#eef3f6;color:var(--navy);font-weight:700}
.row{display:flex;gap:8px;align-items:center}
input[type="file"]{display:none}
.url-input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(6,40,61,0.08)}
@media(max-width:900px){.panel{width:100%}.scene img{max-width:calc(100vw - 48px);max-height:60vh}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Hotspot Studio URL Edition">
Â Â <header class="header">
Â Â Â Â <div class="title-row">
Â Â Â Â Â Â <h1>Hotspot Studio</h1>
Â Â Â Â Â Â <div class="mode-ind" id="modeIndicator">Author Mode</div>
Â Â Â Â </div>
Â Â Â Â <div class="smallmuted credit">- Will Salter (URL edition)</div>
Â Â Â Â <div class="top-controls" aria-hidden="false">
Â Â Â Â Â Â <label class="btn" for="fileImage">ğŸ“ Upload image</label>
Â Â Â Â Â Â <input id="fileImage" type="file" accept="image/*" />
Â Â Â Â Â Â <button class="btn ghost" id="btnLoadImageUrl">ğŸ”— Load Image from URL</button>

Â Â Â Â Â Â <label class="btn ghost" for="fileScene">ğŸ“‚ Load Scene (file)</label>
Â Â Â Â Â Â <input id="fileScene" type="file" accept="application/json" />

Â Â Â Â Â Â <button class="btn ghost" id="btnLoadSceneUrl">ğŸ”— Load Scene from URL</button>

Â Â Â Â Â Â <button class="btn ghost" id="btnSave">ğŸ’¾ Save JSON</button>
Â Â Â Â Â Â <button class="btn ghost" id="btnUndo">â†©ï¸ Undo</button>
Â Â Â Â Â Â <button class="btn" id="btnToggleMode">ğŸ“ Switch to Explore Mode</button>
Â Â Â Â Â Â <button class="btn ghost" id="btnResetSummary">ğŸ”„ Reset Explore</button>
Â Â Â Â </div>
Â Â </header>

Â Â <div class="main">
Â Â Â Â <aside class="panel" aria-label="Controls">
Â Â Â Â Â Â <div><strong class="smallmuted">Selected hotspot</strong></div>
Â Â Â Â Â Â <div id="noSelection" class="smallmuted" style="margin-top:6px">No hotspot selected â€” click one on the image to edit.</div>

Â Â Â Â Â Â <div id="editor" style="display:none">
Â Â Â Â Â Â Â Â <label class="smallmuted">Title</label>
Â Â Â Â Â Â Â Â <input id="hotTitle" type="text" />
Â Â Â Â Â Â Â Â <label class="smallmuted">Text</label>
Â Â Â Â Â Â Â Â <textarea id="hotText"></textarea>
Â Â Â Â Â Â Â Â <div class="row" style="margin-top:8px">
Â Â Â Â Â Â Â Â Â Â <div style="flex:1">
Â Â Â Â Â Â Â Â Â Â Â Â <label class="smallmuted">Colour</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input id="hotColor" type="color" />
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div style="width:120px">
Â Â Â Â Â Â Â Â Â Â Â Â <label class="smallmuted">Size</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input id="hotSize" type="range" min="14" max="48" value="22" />
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <div class="row" style="margin-top:8px;gap:8px">
Â Â Â Â Â Â Â Â Â Â <button class="btn ghost" id="btnDeleteHot">Delete</button>
Â Â Â Â Â Â Â Â Â Â <button class="btn ghost" id="btnCloseEditor">Close</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div style="margin-top:12px">
Â Â Â Â Â Â Â Â <strong class="smallmuted">Hotspot list</strong>
Â Â Â Â Â Â Â Â <div class="list" id="hotspotList" aria-live="polite"></div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div style="margin-top:12px">
Â Â Â Â Â Â Â Â <strong class="smallmuted">Found Hotspots</strong>
Â Â Â Â Â Â Â Â <div id="foundList" style="margin-top:8px;font-size:14px;color:var(--muted)"></div>
Â Â Â Â Â Â Â Â <div id="completion" class="smallmuted" style="margin-top:8px"></div>
Â Â Â Â Â Â </div>
Â Â Â Â </aside>

Â Â Â Â <div class="stage-wrap">
Â Â Â Â Â Â <div class="stage" id="stage">
Â Â Â Â Â Â Â Â <div id="scene" class="scene author" tabindex="0" aria-label="Hotspot scene">
Â Â Â Â Â Â Â Â Â Â <div id="emptyPrompt" style="padding:36px;text-align:center;color:var(--muted)">
Â Â Â Â Â Â Â Â Â Â Â Â No image yet â€” upload or load one to begin.
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="footer smallmuted">Hotspot Studio â€” URL edition. Keep your original file safe.</div>
Â Â Â Â </div>
Â Â </div>
</div>

<!-- editor modal -->
<div class="editor-overlay" id="editorOverlay" role="dialog" aria-modal="true">
Â Â <div class="editor-box">
Â Â Â Â <h3 style="margin:0 0 6px 0">Edit Hotspot</h3>
Â Â Â Â <label>Title <input id="editTitle" type="text" /></label>
Â Â Â Â <label>Text <textarea id="editText"></textarea></label>
Â Â Â Â <label>Colour <input id="editColor" type="color" /></label>
Â Â Â Â <label>Size <input id="editSize" type="number" min="8" max="100" /></label>
Â Â Â Â <div class="editor-actions">
Â Â Â Â Â Â <button class="btn ghost" id="btnCloseEditorModal">Close</button>
Â Â Â Â </div>
Â Â </div>
</div>

<script>
/*
Â Â Hotspot Studio â€” URL edition
Â Â - Supports local uploads AND loading images by URL (including Google Drive share links)
Â Â - Supports loading scene JSON from file or from a URL
Â Â - Scene model:
Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â imageDataUrl?: string,Â  Â  // embedded base64 (used when author uploads local file and saves)
Â Â Â Â Â Â Â Â imageURL?: string,Â  Â  Â  Â  // external URL (Drive or hosted)
Â Â Â Â Â Â Â Â hotspots: [{id,x,y,color,size,title,text}]
Â Â Â Â Â Â }
*/

(() => {
Â Â // Elements
Â Â const fileImage = document.getElementById('fileImage');
Â Â const btnLoadImageUrl = document.getElementById('btnLoadImageUrl');
Â Â const fileScene = document.getElementById('fileScene');
Â Â const btnLoadSceneUrl = document.getElementById('btnLoadSceneUrl');
Â Â const btnSave = document.getElementById('btnSave');
Â Â const btnUndo = document.getElementById('btnUndo');
Â Â const btnToggleMode = document.getElementById('btnToggleMode');
Â Â const btnResetSummary = document.getElementById('btnResetSummary');

Â Â const sceneEl = document.getElementById('scene');
Â Â const emptyPrompt = document.getElementById('emptyPrompt');
Â Â const hotspotList = document.getElementById('hotspotList');

Â Â const noSelection = document.getElementById('noSelection');
Â Â const editorPanel = document.getElementById('editor');
Â Â const hotTitle = document.getElementById('hotTitle');
Â Â const hotText = document.getElementById('hotText');
Â Â const hotColor = document.getElementById('hotColor');
Â Â const hotSize = document.getElementById('hotSize');
Â Â const btnDeleteHot = document.getElementById('btnDeleteHot');
Â Â const btnCloseEditor = document.getElementById('btnCloseEditor');

Â Â const editorOverlay = document.getElementById('editorOverlay');
Â Â const editTitle = document.getElementById('editTitle');
Â Â const editText = document.getElementById('editText');
Â Â const editColor = document.getElementById('editColor');
Â Â const editSize = document.getElementById('editSize');
Â Â const btnCloseEditorModal = document.getElementById('btnCloseEditorModal');

Â Â const foundListEl = document.getElementById('foundList');
Â Â const completionEl = document.getElementById('completion');
Â Â const modeIndicator = document.getElementById('modeIndicator');

Â Â // state
Â Â let scene = { imageDataUrl: null, imageURL: null, hotspots: [] };
Â Â let selectedHotId = null;
Â Â let isExploreMode = false;
Â Â let foundSet = new Set();

Â Â // utils
Â Â const uid = () => 'h' + Math.random().toString(36).slice(2,9);
Â Â const pct = (v) => Math.round(v*100)/100;
Â Â const escapeHtml = (s) => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

Â Â // -------------------------
Â Â // Load image from local file
Â Â // -------------------------
Â Â fileImage.addEventListener('change', async (e) => {
Â Â Â Â const f = e.target.files && e.target.files[0];
Â Â Â Â if(!f) return;
Â Â Â Â try {
Â Â Â Â Â Â const dataUrl = await readFileAsDataURL(f);
Â Â Â Â Â Â scene.imageDataUrl = dataUrl;
Â Â Â Â Â Â scene.imageURL = null;
Â Â Â Â Â Â scene.hotspots = [];
Â Â Â Â Â Â foundSet.clear();
Â Â Â Â Â Â renderScene();
Â Â Â Â } catch (err) {
Â Â Â Â Â Â alert('Error loading image: ' + err.message);
Â Â Â Â } finally {
Â Â Â Â Â Â fileImage.value = '';
Â Â Â Â }
Â Â });

Â Â // -------------------------
Â Â // Load image from URL button
Â Â // -------------------------
Â Â btnLoadImageUrl.addEventListener('click', async () => {
Â Â Â Â const url = prompt('Paste an image URL (or Google Drive share link):');
Â Â Â Â if(!url) return;
Â Â Â Â const direct = convertDriveUrlToDirect(url.trim());
Â Â Â Â try {
Â Â Â Â Â Â // try to fetch the image to check it loads
Â Â Â Â Â Â await checkImageLoadable(direct);
Â Â Â Â Â Â scene.imageURL = direct;
Â Â Â Â Â Â scene.imageDataUrl = null; // prefer URL when set
Â Â Â Â Â Â scene.hotspots = [];
Â Â Â Â Â Â foundSet.clear();
Â Â Â Â Â Â renderScene();
Â Â Â Â Â Â alert('Image loaded from URL.');
Â Â Â Â } catch (err) {
Â Â Â Â Â Â alert('Could not load image from that URL. Error: ' + err.message + '\nIf the image is in Google Drive, make sure the file is shared "Anyone with the link â€“ Viewer".');
Â Â Â Â }
Â Â });

Â Â // -------------------------
Â Â // Load scene from local file (JSON)
Â Â // -------------------------
Â Â fileScene.addEventListener('change', async (e) => {
Â Â Â Â const f = e.target.files && e.target.files[0];
Â Â Â Â if(!f) return;
Â Â Â Â try {
Â Â Â Â Â Â const text = await readFileAsText(f);
Â Â Â Â Â Â const obj = JSON.parse(text);
Â Â Â Â Â Â await applyLoadedScene(obj);
Â Â Â Â Â Â alert('Scene loaded from file.');
Â Â Â Â } catch (err) {
Â Â Â Â Â Â alert('Failed to load scene: ' + err.message);
Â Â Â Â } finally {
Â Â Â Â Â Â fileScene.value = '';
Â Â Â Â }
Â Â });

Â Â // -------------------------
Â Â // Load scene from URL (JSON)
Â Â // -------------------------
Â Â btnLoadSceneUrl.addEventListener('click', async () => {
Â Â Â Â const url = prompt('Paste a scene JSON URL (e.g. hosted file or Google Drive link):');
Â Â Â Â if(!url) return;
Â Â Â Â const direct = convertDriveUrlToDirect(url.trim());
Â Â Â Â try {
Â Â Â Â Â Â const res = await fetch(direct, {mode:'cors'});
Â Â Â Â Â Â if(!res.ok) throw new Error('HTTP ' + res.status);
Â Â Â Â Â Â const obj = await res.json();
Â Â Â Â Â Â await applyLoadedScene(obj);
Â Â Â Â Â Â alert('Scene loaded from URL.');
Â Â Â Â } catch (err) {
Â Â Â Â Â Â alert('Could not fetch scene JSON from that URL. Error: ' + err.message + '\nIf using Google Drive, ensure the file is shared and allow public view.');
Â Â Â Â }
Â Â });

Â Â // -------------------------
Â Â // Save (export) scene
Â Â // -------------------------
Â Â btnSave.addEventListener('click', () => {
Â Â Â Â // ensure exported JSON includes either imageURL (if set) or embedded imageDataUrl (if available)
Â Â Â Â const exportObj = { hotspots: scene.hotspots.slice() };
Â Â Â Â if(scene.imageURL) exportObj.imageURL = scene.imageURL;
Â Â Â Â else if(scene.imageDataUrl) exportObj.imageDataUrl = scene.imageDataUrl;
Â Â Â Â else exportObj.imageURL = null;
Â Â Â Â downloadData(JSON.stringify(exportObj, null, 2), 'hotspot-scene.json', 'application/json');
Â Â });

Â Â // -------------------------
Â Â // Undo (last hotspot)
Â Â // -------------------------
Â Â btnUndo.addEventListener('click', () => {
Â Â Â Â if(isExploreMode) return;
Â Â Â Â scene.hotspots.pop();
Â Â Â Â renderScene();
Â Â });

Â Â // -------------------------
Â Â // Toggle mode
Â Â // -------------------------
Â Â btnToggleMode.addEventListener('click', () => {
Â Â Â Â isExploreMode = !isExploreMode;
Â Â Â Â document.body.classList.toggle('explore-mode', isExploreMode);
Â Â Â Â modeIndicator.textContent = isExploreMode ? 'Explore Mode' : 'Author Mode';
Â Â Â Â foundSet.clear();
Â Â Â Â updateSummary();
Â Â Â Â renderScene();
Â Â });

Â Â // -------------------------
Â Â // Reset summary
Â Â // -------------------------
Â Â btnResetSummary.addEventListener('click', () => {
Â Â Â Â foundSet.clear();
Â Â Â Â updateSummary();
Â Â });

Â Â // -------------------------
Â Â // Scene rendering
Â Â // -------------------------
Â Â function renderScene() {
Â Â Â Â sceneEl.innerHTML = '';
Â Â Â Â if(!scene.imageDataUrl && !scene.imageURL) {
Â Â Â Â Â Â sceneEl.appendChild(emptyPrompt);
Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â const img = document.createElement('img');
Â Â Â Â img.alt = 'Hotspot scene image';
Â Â Â Â img.draggable = false;
Â Â Â Â if(scene.imageURL) img.src = scene.imageURL;
Â Â Â Â else img.src = scene.imageDataUrl;
Â Â Â Â sceneEl.appendChild(img);

Â Â Â Â img.onload = () => {
Â Â Â Â Â Â // create hotspots
Â Â Â Â Â Â scene.hotspots.forEach(h => {
Â Â Â Â Â Â Â Â const el = makeHotspotElement(h);
Â Â Â Â Â Â Â Â sceneEl.appendChild(el);
Â Â Â Â Â Â });
Â Â Â Â Â Â rebuildHotspotList();
Â Â Â Â };

Â Â Â Â img.onerror = () => {
Â Â Â Â Â Â alert('Image failed to load. If using a Drive link, make sure the file is shared so anyone with the link can view it.');
Â Â Â Â Â Â scene.imageURL = null;
Â Â Â Â Â Â scene.imageDataUrl = null;
Â Â Â Â Â Â scene.hotspots = [];
Â Â Â Â Â Â sceneEl.innerHTML = '';
Â Â Â Â Â Â sceneEl.appendChild(emptyPrompt);
Â Â Â Â };
Â Â }

Â Â // -------------------------
Â Â // Make hotspot element
Â Â // -------------------------
Â Â function makeHotspotElement(h) {
Â Â Â Â const hs = document.createElement('button');
Â Â Â Â hs.className = 'hotspot';
Â Â Â Â hs.type = 'button';
Â Â Â Â hs.dataset.id = h.id;
Â Â Â Â hs.style.left = h.x + '%';
Â Â Â Â hs.style.top = h.y + '%';
Â Â Â Â hs.style.width = (h.size + 8) + 'px';
Â Â Â Â hs.style.height = (h.size + 8) + 'px';

Â Â Â Â const dot = document.createElement('span');
Â Â Â Â dot.className = 'dot';
Â Â Â Â dot.style.background = h.color;
Â Â Â Â dot.style.width = h.size + 'px';
Â Â Â Â dot.style.height = h.size + 'px';
Â Â Â Â hs.appendChild(dot);

Â Â Â Â const label = document.createElement('div');
Â Â Â Â label.className = 'label';
Â Â Â Â label.innerHTML = '<strong>' + escapeHtml(h.title || '') + '</strong><div style="margin-top:6px;font-weight:400;font-size:13px;line-height:1.3">' + escapeHtml(h.text || '') + '</div>';
Â Â Â Â hs.appendChild(label);

Â Â Â Â hs.addEventListener('click', (evt) => {
Â Â Â Â Â Â evt.stopPropagation();
Â Â Â Â Â Â if(isExploreMode) {
Â Â Â Â Â Â Â Â const id = h.id;
Â Â Â Â Â Â Â Â if(!foundSet.has(id)) {
Â Â Â Â Â Â Â Â Â Â foundSet.add(id);
Â Â Â Â Â Â Â Â Â Â updateSummary();
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â // allow label toggle on touch if needed
Â Â Â Â Â Â Â Â hs.dataset.open = hs.dataset.open === 'true' ? '' : 'true';
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â Â Â selectHotspot(h.id);
Â Â Â Â });

Â Â Â Â hs.addEventListener('mouseenter', () => {
Â Â Â Â Â Â if(isExploreMode && !foundSet.has(h.id)) {
Â Â Â Â Â Â Â Â foundSet.add(h.id);
Â Â Â Â Â Â Â Â updateSummary();
Â Â Â Â Â Â }
Â Â Â Â });

Â Â Â Â // dragging in author mode
Â Â Â Â let dragging = null;
Â Â Â Â hs.addEventListener('pointerdown', (ev) => {
Â Â Â Â Â Â if(isExploreMode) return;
Â Â Â Â Â Â ev.preventDefault();
Â Â Â Â Â Â hs.setPointerCapture?.(ev.pointerId);
Â Â Â Â Â Â dragging = { id: ev.pointerId };
Â Â Â Â });
Â Â Â Â hs.addEventListener('pointermove', (ev) => {
Â Â Â Â Â Â if(isExploreMode || !dragging) return;
Â Â Â Â Â Â const img = sceneEl.querySelector('img');
Â Â Â Â Â Â if(!img) return;
Â Â Â Â Â Â const rect = img.getBoundingClientRect();
Â Â Â Â Â Â let x = (ev.clientX - rect.left) / rect.width;
Â Â Â Â Â Â let y = (ev.clientY - rect.top) / rect.height;
Â Â Â Â Â Â x = Math.max(0,Math.min(1,x)); y = Math.max(0,Math.min(1,y));
Â Â Â Â Â Â hs.style.left = (x*100) + '%';
Â Â Â Â Â Â hs.style.top = (y*100) + '%';
Â Â Â Â });
Â Â Â Â hs.addEventListener('pointerup', (ev) => {
Â Â Â Â Â Â if(!dragging) return;
Â Â Â Â Â Â hs.releasePointerCapture?.(ev.pointerId);
Â Â Â Â Â Â dragging = null;
Â Â Â Â Â Â // write back to scene model
Â Â Â Â Â Â const left = parseFloat(hs.style.left); const top = parseFloat(hs.style.top);
Â Â Â Â Â Â const hot = scene.hotspots.find(x=>x.id===h.id);
Â Â Â Â Â Â if(hot){ hot.x = left; hot.y = top; saveToTemp(); rebuildHotspotList(); }
Â Â Â Â });

Â Â Â Â return hs;
Â Â }

Â Â // -------------------------
Â Â // Select / edit hotspot
Â Â // -------------------------
Â Â function selectHotspot(id) {
Â Â Â Â const hot = scene.hotspots.find(h => h.id === id);
Â Â Â Â if(!hot) return;
Â Â Â Â selectedHotId = id;
Â Â Â Â noSelection.style.display = 'none';
Â Â Â Â editorPanel.style.display = 'block';
Â Â Â Â hotTitle.value = hot.title || '';
Â Â Â Â hotText.value = hot.text || '';
Â Â Â Â hotColor.value = hot.color || '#ff6b6b';
Â Â Â Â hotSize.value = hot.size || 22;

Â Â Â Â hotTitle.oninput = () => { hot.title = hotTitle.value; updateHotUI(id); saveToTemp(); rebuildHotspotList(); };
Â Â Â Â hotText.oninput = () => { hot.text = hotText.value; updateHotUI(id); saveToTemp(); };
Â Â Â Â hotColor.oninput = () => { hot.color = hotColor.value; updateHotUI(id); saveToTemp(); rebuildHotspotList(); };
Â Â Â Â hotSize.oninput = () => { hot.size = parseInt(hotSize.value,10); updateHotUI(id); saveToTemp(); rebuildHotspotList(); };

Â Â Â Â btnDeleteHot.onclick = () => {
Â Â Â Â Â Â if(!confirm('Delete this hotspot?')) return;
Â Â Â Â Â Â scene.hotspots = scene.hotspots.filter(h => h.id !== id);
Â Â Â Â Â Â selectedHotId = null;
Â Â Â Â Â Â renderScene();
Â Â Â Â Â Â saveToTemp();
Â Â Â Â };

Â Â Â Â btnCloseEditor.onclick = () => { deselectHotspot(); };
Â Â Â Â // Visual highlight
Â Â Â Â Array.from(sceneEl.querySelectorAll('.hotspot')).forEach(el => { el.style.boxShadow = (el.dataset.id === id) ? '0 8px 22px rgba(43,140,255,0.12)' : 'none'; });
Â Â }

Â Â function deselectHotspot() {
Â Â Â Â selectedHotId = null;
Â Â Â Â editorPanel.style.display = 'none';
Â Â Â Â noSelection.style.display = 'block';
Â Â Â Â Array.from(sceneEl.querySelectorAll('.hotspot')).forEach(el => el.style.boxShadow = 'none');
Â Â }

Â Â function updateHotUI(id) {
Â Â Â Â const hot = scene.hotspots.find(h=>h.id===id); if(!hot) return;
Â Â Â Â const el = sceneEl.querySelector(`.hotspot[data-id="${id}"]`);
Â Â Â Â if(el) {
Â Â Â Â Â Â const dot = el.querySelector('.dot'); dot.style.background = hot.color; dot.style.width = hot.size + 'px'; dot.style.height = hot.size + 'px';
Â Â Â Â Â Â el.style.width = (hot.size + 8) + 'px'; el.style.height = (hot.size + 8) + 'px';
Â Â Â Â Â Â const label = el.querySelector('.label'); label.innerHTML = '<strong>' + escapeHtml(hot.title || '') + '</strong><div style="margin-top:6px;font-weight:400;font-size:13px;line-height:1.3">' + escapeHtml(hot.text || '') + '</div>';
Â Â Â Â }
Â Â }

Â Â // -------------------------
Â Â // Hotspot list & summary
Â Â // -------------------------
Â Â function rebuildHotspotList() {
Â Â Â Â hotspotList.innerHTML = '';
Â Â Â Â scene.hotspots.forEach((h, idx) => {
Â Â Â Â Â Â const item = document.createElement('div'); item.className = 'item'; item.dataset.id = h.id;
Â Â Â Â Â Â const mini = document.createElement('div'); mini.className = 'mini'; mini.style.background = h.color; item.appendChild(mini);
Â Â Â Â Â Â const info = document.createElement('div'); info.style.flex = '1'; info.innerHTML = '<div style="font-weight:600;font-size:14px">' + escapeHtml(h.title || 'Untitled') + '</div><div class="smallmuted">x:' + pct(h.x) + '%, y:' + pct(h.y) + '%</div>'; item.appendChild(info);
Â Â Â Â Â Â const edit = document.createElement('button'); edit.className = 'btn ghost'; edit.textContent = 'Edit'; edit.onclick = () => { selectHotspot(h.id); };
Â Â Â Â Â Â item.appendChild(edit);
Â Â Â Â Â Â hotspotList.appendChild(item);
Â Â Â Â });
Â Â }

Â Â function updateSummary() {
Â Â Â Â foundListEl.innerHTML = '';
Â Â Â Â Array.from(foundSet).forEach(id => {
Â Â Â Â Â Â const hot = scene.hotspots.find(h => h.id === id);
Â Â Â Â Â Â if(!hot) return;
Â Â Â Â Â Â const d = document.createElement('div'); d.innerHTML = '<strong>' + escapeHtml(hot.title) + '</strong>: ' + escapeHtml(hot.text); foundListEl.appendChild(d);
Â Â Â Â });
Â Â Â Â if(scene.hotspots.length > 0) {
Â Â Â Â Â Â completionEl.textContent = `Found ${foundSet.size} of ${scene.hotspots.length} hotspots (${ Math.round(foundSet.size / scene.hotspots.length * 100) }%)`;
Â Â Â Â } else completionEl.textContent = '';
Â Â }

Â Â // -------------------------
Â Â // Add hotspot on click (author)
Â Â // -------------------------
Â Â sceneEl.addEventListener('click', (e) => {
Â Â Â Â if(isExploreMode) return;
Â Â Â Â const img = sceneEl.querySelector('img'); if(!img) return;
Â Â Â Â if(e.target && e.target.closest('.hotspot')) return; // clicked on hotspot already
Â Â Â Â const rect = img.getBoundingClientRect();
Â Â Â Â if(e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;
Â Â Â Â const x = (e.clientX - rect.left) / rect.width * 100;
Â Â Â Â const y = (e.clientY - rect.top) / rect.height * 100;
Â Â Â Â const newHot = { id: uid(), x: x, y: y, color: '#ff6b6b', size: 22, title: 'New hotspot', text: 'Edit this description' };
Â Â Â Â scene.hotspots.push(newHot);
Â Â Â Â const el = makeHotspotElement(newHot);
Â Â Â Â sceneEl.appendChild(el);
Â Â Â Â selectHotspot(newHot.id);
Â Â Â Â saveToTemp();
Â Â Â Â rebuildHotspotList();
Â Â });

Â Â // -------------------------
Â Â // Helpers: file reader, download
Â Â // -------------------------
Â Â function readFileAsDataURL(file) {
Â Â Â Â return new Promise((res, rej) => {
Â Â Â Â Â Â const r = new FileReader();
Â Â Â Â Â Â r.onload = () => res(r.result);
Â Â Â Â Â Â r.onerror = () => rej(r.error);
Â Â Â Â Â Â r.readAsDataURL(file);
Â Â Â Â });
Â Â }
Â Â function readFileAsText(file) {
Â Â Â Â return new Promise((res, rej) => {
Â Â Â Â Â Â const r = new FileReader();
Â Â Â Â Â Â r.onload = () => res(r.result);
Â Â Â Â Â Â r.onerror = () => rej(r.error);
Â Â Â Â Â Â r.readAsText(file);
Â Â Â Â });
Â Â }
Â Â function downloadData(str, filename, mime) {
Â Â Â Â const blob = new Blob([str], { type: mime || 'application/octet-stream' });
Â Â Â Â const url = URL.createObjectURL(blob);
Â Â Â Â const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
Â Â }

Â Â // -------------------------
Â Â // Convert Google Drive share link to direct 'uc?export=view' url
Â Â // Accepts various drive link formats and returns a direct usable URL
Â Â // -------------------------
Â Â function convertDriveUrlToDirect(url) {
Â Â Â Â try {
Â Â Â Â Â Â // If already looks like a data: or http(s) direct image, return as-is
Â Â Â Â Â Â if(url.startsWith('data:') || url.match(/^https?:\/\/.+\.(png|jpg|jpeg|gif|webp|svg)(?:$|\?)/i)) return url;
Â Â Â Â Â Â // Patterns for standard google drive share links
Â Â Â Â Â Â // /file/d/FILEID/view?...Â  or ?id=FILEID
Â Â Â Â Â Â const m1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
Â Â Â Â Â Â if(m1 && m1[1]) return `https://drive.google.com/uc?export=view&id=${m1[1]}`;
Â Â Â Â Â Â const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
Â Â Â Â Â Â if(m2 && m2[1]) return `https://drive.google.com/uc?export=view&id=${m2[1]}`;
Â Â Â Â Â Â // fallback: return original (might work)
Â Â Â Â Â Â return url;
Â Â Â Â } catch (e) {
Â Â Â Â Â Â return url;
Â Â Â Â }
Â Â }

Â Â // -------------------------
Â Â // Check image is loadable (try to fetch as blob then createObjectURL)
Â Â // -------------------------
Â Â async function checkImageLoadable(url) {
Â Â Â Â // attempt to fetch (CORS might block, but for Drive links it often allows view)
Â Â Â Â const res = await fetch(url, {mode:'cors'});
Â Â Â Â if(!res.ok) throw new Error('HTTP ' + res.status);
Â Â Â Â const blob = await res.blob();
Â Â Â Â // lightweight check: ensure it's an image
Â Â Â Â if(!blob.type.startsWith('image/')) throw new Error('Fetched resource is not an image (type: ' + blob.type + ')');
Â Â Â Â // We won't store objectURL permanently, but it's a good check
Â Â Â Â return true;
Â Â }

Â Â // -------------------------
Â Â // Apply loaded scene object (from file or fetched JSON)
Â Â // -------------------------
Â Â async function applyLoadedScene(obj) {
Â Â Â Â if(!obj || !Array.isArray(obj.hotspots)) throw new Error('Invalid scene JSON (missing hotspots)');
Â Â Â Â // reset
Â Â Â Â scene.hotspots = obj.hotspots.map(h => ({ id: h.id || uid(), x: h.x, y: h.y, color: h.color || '#ff6b6b', size: h.size || 22, title: h.title || 'Hotspot', text: h.text || '' }));
Â Â Â Â foundSet.clear();
Â Â Â Â // prefer imageURL if provided
Â Â Â Â if(obj.imageURL) {
Â Â Â Â Â Â const direct = convertDriveUrlToDirect(obj.imageURL);
Â Â Â Â Â Â // attempt to load
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â await checkImageLoadable(direct);
Â Â Â Â Â Â Â Â scene.imageURL = direct;
Â Â Â Â Â Â Â Â scene.imageDataUrl = null;
Â Â Â Â Â Â Â Â renderScene();
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â } catch (err) {
Â Â Â Â Â Â Â Â throw new Error('Could not fetch image from provided URL. ' + err.message);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â // else if embedded data present
Â Â Â Â if(obj.imageDataUrl) {
Â Â Â Â Â Â scene.imageDataUrl = obj.imageDataUrl;
Â Â Â Â Â Â scene.imageURL = null;
Â Â Â Â Â Â renderScene();
Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â // fallback: no image in JSON (old style expects a local image)
Â Â Â Â scene.imageDataUrl = null; scene.imageURL = null;
Â Â Â Â renderScene();
Â Â Â Â alert('This scene does not include an image. Please load the matching image file manually (Upload Image).');
Â Â }

Â Â // -------------------------
Â Â // Save temp to localStorage (optional autosave)
Â Â // -------------------------
Â Â const LS_KEY = 'hotspot-studio-url-scene-v1';
Â Â function saveToTemp() {
Â Â Â Â try {
Â Â Â Â Â Â const exportObj = { hotspots: scene.hotspots.slice() };
Â Â Â Â Â Â if(scene.imageURL) exportObj.imageURL = scene.imageURL;
Â Â Â Â Â Â else if(scene.imageDataUrl) exportObj.imageDataUrl = scene.imageDataUrl;
Â Â Â Â Â Â localStorage.setItem(LS_KEY, JSON.stringify(exportObj));
Â Â Â Â } catch(e){}
Â Â }
Â Â function loadFromTemp() {
Â Â Â Â try {
Â Â Â Â Â Â const raw = localStorage.getItem(LS_KEY);
Â Â Â Â Â Â if(!raw) return;
Â Â Â Â Â Â const obj = JSON.parse(raw);
Â Â Â Â Â Â if(obj) applyLoadedScene(obj).catch(()=>{});
Â Â Â Â } catch(e){}
Â Â }
Â Â loadFromTemp();

Â Â // -------------------------
Â Â // Utility: apply saved hotspot changes to DOM list
Â Â // -------------------------
Â Â function saveAndRebuild() { saveToTemp(); rebuildHotspotList(); }

Â Â // -------------------------
Â Â // Helper to download JSON (done above) and other utilities
Â Â // -------------------------
Â Â function downloadData(str, filename, mime) {
Â Â Â Â const blob = new Blob([str], { type: mime || 'application/octet-stream' });
Â Â Â Â const url = URL.createObjectURL(blob);
Â Â Â Â const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
Â Â }

Â Â // -------------------------
Â Â // Small helpers again (dup safe)
Â Â // -------------------------
Â Â function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsDataURL(file); }); }
Â Â function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsText(file); }); }

Â Â // -------------------------
Â Â // Initial render (empty)
Â Â // -------------------------
Â Â renderScene();

Â Â // -------------------------
Â Â // expose for debugging if needed
Â Â // -------------------------
Â Â window.HotspotStudioURL = {
Â Â Â Â getScene: () => scene,
Â Â Â Â loadSceneObject: (obj) => applyLoadedScene(obj)
Â Â };

})(); // end IIFE
</script>
</body>
</html>
